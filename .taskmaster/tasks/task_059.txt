# Task ID: 59
# Title: Create End-to-End Test Scenarios
# Status: done
# Dependencies: None
# Priority: high
# Description: Develop comprehensive test scripts for end-to-end testing of the complete orchestrator system
# Details:
Successfully created comprehensive end-to-end test suite with 4 test scenarios:

1. New User Setup Test (tests/scenarios/new-user.sh):
```bash
#!/bin/bash
set -e

# Test script for new user setup scenario
echo "Running New User Setup Test"

# Clean test environment
rm -rf ~/.claude-test
CLAUDE_HOME=~/.claude-test claude init

# Verify initial setup
if [ ! -d "$HOME/.claude-test" ]; then
  echo "FAIL: Claude home directory not created"
  exit 1
fi

# Create first project
CLAUDE_HOME=~/.claude-test claude project create --name first-project --template web-app
echo "✓ Created first project"

# Verify project creation
if [ ! -d "$HOME/.claude-test/projects/first-project" ]; then
  echo "FAIL: Project directory not created"
  exit 1
fi

# Create second project
CLAUDE_HOME=~/.claude-test claude project create --name second-project --template base
echo "✓ Created second project"

# Test switching between projects
CLAUDE_HOME=~/.claude-test claude project switch first-project
CURRENT=$(CLAUDE_HOME=~/.claude-test claude project current)
if [ "$CURRENT" != "first-project" ]; then
  echo "FAIL: Project switch failed"
  exit 1
fi
echo "✓ Switched to first project"

CLAUDE_HOME=~/.claude-test claude project switch second-project
CURRENT=$(CLAUDE_HOME=~/.claude-test claude project current)
if [ "$CURRENT" != "second-project" ]; then
  echo "FAIL: Project switch failed"
  exit 1
fi
echo "✓ Switched to second project"

echo "New User Setup Test: PASSED"
```

2. Migration Scenario Test (tests/scenarios/migration.sh):
```bash
#!/bin/bash
set -e

# Test script for migration scenario
echo "Running Migration Scenario Test"

# Setup test environment
rm -rf ~/.claude-test
CLAUDE_HOME=~/.claude-test claude init

# Create mock diet103 project
mkdir -p ~/diet103-test/project1
touch ~/diet103-test/project1/Claude.md
echo '{"name":"legacy-project"}' > ~/diet103-test/project1/metadata.json

# Register existing diet103 project
CLAUDE_HOME=~/.claude-test claude project register --path ~/diet103-test/project1
echo "✓ Registered legacy project"

# Verify project registration
CLAUDE_HOME=~/.claude-test claude project list | grep legacy-project
if [ $? -ne 0 ]; then
  echo "FAIL: Legacy project not registered"
  exit 1
fi

# Test switching to legacy project
CLAUDE_HOME=~/.claude-test claude project switch legacy-project
CURRENT=$(CLAUDE_HOME=~/.claude-test claude project current)
if [ "$CURRENT" != "legacy-project" ]; then
  echo "FAIL: Legacy project switch failed"
  exit 1
fi
echo "✓ Switched to legacy project"

# Create new project
CLAUDE_HOME=~/.claude-test claude project create --name new-project --template base
echo "✓ Created new project"

# Test switching between legacy and new
CLAUDE_HOME=~/.claude-test claude project switch new-project
CLAUDE_HOME=~/.claude-test claude project switch legacy-project

echo "Migration Scenario Test: PASSED"
```

3. Power User Workflow Test (tests/scenarios/power-user.sh):
```bash
#!/bin/bash
set -e

# Test script for power user workflow
echo "Running Power User Workflow Test"

# Setup test environment
rm -rf ~/.claude-test
CLAUDE_HOME=~/.claude-test claude init

# Create multiple projects (10+)
for i in {1..12}; do
  CLAUDE_HOME=~/.claude-test claude project create --name "project-$i" --template base
  echo "✓ Created project-$i"
done

# Test rapid switching between projects
echo "Testing rapid project switching..."
for i in {1..12}; do
  start_time=$(date +%s.%N)
  CLAUDE_HOME=~/.claude-test claude project switch "project-$i"
  end_time=$(date +%s.%N)
  duration=$(echo "$end_time - $start_time" | bc)
  echo "  Switch to project-$i took $duration seconds"
  
  # Verify correct project
  CURRENT=$(CLAUDE_HOME=~/.claude-test claude project current)
  if [ "$CURRENT" != "project-$i" ]; then
    echo "FAIL: Project switch to project-$i failed"
    exit 1
  fi
done

# Test natural language commands (if implemented)
if command -v CLAUDE_HOME=~/.claude-test claude nl &> /dev/null; then
  echo "Testing natural language commands..."
  CLAUDE_HOME=~/.claude-test claude nl "switch to project 5" 
  CURRENT=$(CLAUDE_HOME=~/.claude-test claude project current)
  if [ "$CURRENT" != "project-5" ]; then
    echo "FAIL: Natural language command failed"
    exit 1
  fi
  echo "✓ Natural language command succeeded"
fi

echo "Power User Workflow Test: PASSED"
```

4. Error Handling Test (tests/scenarios/error-recovery.sh):
```bash
#!/bin/bash
set -e

# Test script for error handling
echo "Running Error Handling Test"

# Setup test environment
rm -rf ~/.claude-test
CLAUDE_HOME=~/.claude-test claude init
CLAUDE_HOME=~/.claude-test claude project create --name test-project --template base

# Test corrupted config recovery
echo "Testing corrupted config recovery..."
echo "{invalid json" > ~/.claude-test/config.json
CLAUDE_HOME=~/.claude-test claude project list
if [ $? -eq 0 ]; then
  echo "✓ Handled corrupted config"
else
  echo "FAIL: Did not handle corrupted config"
  exit 1
fi

# Restore valid config
CLAUDE_HOME=~/.claude-test claude init --force

# Test missing project files
echo "Testing missing project files..."
rm -rf ~/.claude-test/projects/test-project/.claude
CLAUDE_HOME=~/.claude-test claude project validate test-project
if [ $? -ne 0 ]; then
  echo "✓ Correctly identified invalid project"
else
  echo "FAIL: Did not detect invalid project"
  exit 1
fi

# Test invalid inputs
echo "Testing invalid inputs..."
CLAUDE_HOME=~/.claude-test claude project switch nonexistent-project
if [ $? -ne 0 ]; then
  echo "✓ Correctly handled nonexistent project"
else
  echo "FAIL: Did not handle nonexistent project correctly"
  exit 1
fi

echo "Error Handling Test: PASSED"
```

5. Master Test Script (tests/run-all-tests.sh):
```bash
#!/bin/bash

# Colors for output formatting
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[0;33m"
NC="\033[0m" # No Color

echo -e "${YELLOW}====================================${NC}"
echo -e "${YELLOW}Running All Orchestrator Test Scenarios${NC}"
echo -e "${YELLOW}====================================${NC}"

# Track results
PASSED=0
FAILED=0
TOTAL=0

# Function to run a test and track results
run_test() {
  TEST_NAME=$1
  TEST_PATH=$2
  
  echo -e "\n${YELLOW}Running: $TEST_NAME${NC}"
  echo -e "${YELLOW}------------------------------------${NC}"
  
  # Make sure script is executable
  chmod +x $TEST_PATH
  
  # Run the test
  if $TEST_PATH; then
    echo -e "${GREEN}✓ $TEST_NAME: PASSED${NC}"
    PASSED=$((PASSED+1))
  else
    echo -e "${RED}✗ $TEST_NAME: FAILED${NC}"
    FAILED=$((FAILED+1))
  fi
  
  TOTAL=$((TOTAL+1))
  echo ""
}

# Run all test scenarios
run_test "New User Setup Test" "./scenarios/new-user.sh"
run_test "Migration Scenario Test" "./scenarios/migration.sh"
run_test "Power User Workflow Test" "./scenarios/power-user.sh"
run_test "Error Handling Test" "./scenarios/error-recovery.sh"

# Print summary
echo -e "${YELLOW}====================================${NC}"
echo -e "${YELLOW}Test Summary${NC}"
echo -e "${YELLOW}====================================${NC}"
echo -e "Total Tests: $TOTAL"
echo -e "${GREEN}Passed: $PASSED${NC}"
echo -e "${RED}Failed: $FAILED${NC}"

# Set exit code based on results
if [ $FAILED -eq 0 ]; then
  echo -e "\n${GREEN}All tests passed successfully!${NC}"
  exit 0
else
  echo -e "\n${RED}Some tests failed. Please check the output above.${NC}"
  exit 1
fi
```

6. Test Documentation (tests/README.md):
```markdown
# Orchestrator End-to-End Tests

This directory contains end-to-end test scenarios for the Claude Orchestrator system.

## Test Scenarios

### 1. New User Setup Test

Tests the initial setup and project creation workflow for new users.

- Initializes a clean test environment
- Creates multiple projects with different templates
- Tests project switching functionality
- Verifies correct project state after each operation

### 2. Migration Scenario Test

Tests the migration path for existing diet103 projects.

- Creates a mock diet103 project structure
- Tests project registration functionality
- Verifies legacy project can be switched to and from
- Ensures compatibility between old and new project formats

### 3. Power User Workflow Test

Tests performance and reliability for power users with many projects.

- Creates 12+ projects in rapid succession
- Measures performance of project switching operations
- Tests natural language command interface (if available)
- Ensures system remains responsive with many projects

### 4. Error Handling Test

Tests system resilience and error recovery capabilities.

- Tests recovery from corrupted configuration
- Tests detection of invalid/missing project files
- Tests handling of invalid user inputs
- Verifies appropriate error messages are displayed

## Running the Tests

### Running All Tests

```bash
# From the tests directory
./run-all-tests.sh
```

### Running Individual Tests

```bash
# From the tests directory
./scenarios/new-user.sh
./scenarios/migration.sh
./scenarios/power-user.sh
./scenarios/error-recovery.sh
```

## Test Environment

All tests use an isolated environment at `~/.claude-test` to prevent interference with your actual Claude configuration. Each test cleans up after itself by removing this directory when done.

## CI Integration

These tests are designed to be run in CI environments. Add the following to your CI configuration:

```yaml
# Example GitHub Actions workflow step
- name: Run E2E Tests
  run: |
    cd tests
    ./run-all-tests.sh
```

## Debugging Failed Tests

If a test fails, you can:

1. Run the individual test script with bash in debug mode:
   ```bash
   bash -x ./scenarios/failing-test.sh
   ```

2. Examine the test environment at `~/.claude-test` before it's cleaned up by modifying the test script to remove the cleanup steps.

3. Check the error messages which should indicate what operation failed and why.

## Adding New Tests

To add a new test scenario:

1. Create a new script in the `scenarios/` directory
2. Follow the pattern of existing tests (setup, test operations, verification)
3. Add your test to `run-all-tests.sh`
4. Document your test in this README
```

Note: These tests cannot be executed yet as the core orchestrator CLI commands are not implemented. These tests will be functional once the CLI implementation tasks are complete.

# Test Strategy:
1. Run each test script individually to verify it works correctly
2. Run the master test script to verify all scenarios pass
3. Test on different operating systems (macOS, Linux) to ensure compatibility
4. Verify error messages are clear and helpful
5. Check that tests clean up after themselves
6. Verify tests don't interfere with actual user configuration
7. Test with both clean and existing environments
8. Integrate tests into CI pipeline once core CLI commands are implemented

# Subtasks:
## 1. Create New User Setup Test [done]
### Dependencies: None
### Description: Develop test script for new user setup scenario that tests initial setup and project creation workflow
### Details:
Created tests/scenarios/new-user.sh that tests initialization, project creation with different templates, and project switching functionality while verifying correct state after each operation.

## 2. Create Migration Scenario Test [done]
### Dependencies: None
### Description: Develop test script for migration scenario that tests registering existing diet103 projects
### Details:
Created tests/scenarios/migration.sh that creates a mock diet103 project structure, tests project registration, and verifies legacy projects can be switched to and from.

## 3. Create Power User Workflow Test [done]
### Dependencies: None
### Description: Develop test script for power user workflow that tests rapid switching between multiple projects
### Details:
Created tests/scenarios/power-user.sh that creates 12+ projects, measures performance of project switching operations, and tests natural language command interface if available.

## 4. Create Error Handling Test [done]
### Dependencies: None
### Description: Develop test script for error handling that tests system resilience and error recovery
### Details:
Created tests/scenarios/error-recovery.sh that tests recovery from corrupted configuration, detection of invalid/missing project files, and handling of invalid user inputs.

## 5. Create Master Test Script [done]
### Dependencies: 59.1, 59.2, 59.3, 59.4
### Description: Develop master test script that runs all scenarios and reports results
### Details:
Created tests/run-all-tests.sh with colored output formatting that runs all test scenarios, tracks passed/failed tests, and provides a summary report with appropriate exit code.

## 6. Create Test Documentation [done]
### Dependencies: 59.1, 59.2, 59.3, 59.4, 59.5
### Description: Create comprehensive documentation for running the tests and interpreting results
### Details:
Created tests/README.md with detailed documentation covering test descriptions, usage instructions, CI integration, debugging guidance, and instructions for adding new tests.

