#!/bin/bash
# Wrapper for task-master add-task with automatic critical evaluation
# Usage: tm-add-task [same args as task-master add-task]

set -e

echo "ğŸ¯ Task Master: Add Task with Critical Evaluation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. Run task-master add-task with all arguments
echo "ğŸ“‹ Adding task..."
task-master add-task "$@"

# Check exit code
if [ $? -ne 0 ]; then
  echo "âŒ Task creation failed"
  exit 1
fi

echo "âœ… Task added successfully"
echo ""

# 2. Check if evaluation is enabled
if [ ! -f .taskmaster/config.json ]; then
  echo "âš ï¸  No config found, skipping evaluation"
  exit 0
fi

EVAL_ENABLED=$(cat .taskmaster/config.json | grep -o '"enableCriticalReview":\s*true' || echo "")

if [ -z "$EVAL_ENABLED" ]; then
  echo "â„¹ï¸  Critical review disabled in config"
  echo "ğŸ’¡ Enable with: config.global.enableCriticalReview = true"
  exit 0
fi

# 3. Run critical evaluation
echo "ğŸ” Running critical evaluation on new task..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

node .taskmaster/scripts/critical-task-evaluator.js

# Check exit code
if [ $? -ne 0 ]; then
  echo ""
  echo "âš ï¸  Evaluation completed with warnings"
  echo "ğŸ“„ Check report for details"
else
  echo ""
  echo "âœ… Evaluation complete!"
fi

# 4. Show summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Task added and evaluated"
echo ""

LATEST_REPORT=$(ls -t .taskmaster/reports/critical-review-*.md 2>/dev/null | head -1)

if [ -n "$LATEST_REPORT" ]; then
  echo "ğŸ“„ Report: $LATEST_REPORT"
  echo "ğŸ’¡ View: code $LATEST_REPORT"
fi

echo ""
echo "ğŸš€ Next steps:"
echo "   View tasks: task-master list"
echo "   Show task: task-master show <id>"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

